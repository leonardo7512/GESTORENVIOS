<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Manifiesto de Env√≠os</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .content { padding: 30px; }
        .panel { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .controles { display: flex; flex-wrap: wrap; align-items: flex-end; gap: 15px; margin-bottom: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 12px;}
        .form-group { display: flex; flex-direction: column;}
        .form-group label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em;}
        .form-group input, .form-group select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; height: 40px; }
        .btn { padding: 10px 25px; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 0 5px; display: inline-block; text-decoration: none; text-align: center; height: 40px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover:not(:disabled) { background: #218838; transform: translateY(-2px); }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        table { width: 100%; min-width: 700px; border-collapse: collapse; }
        table th { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 15px; text-align: left; font-size: 0.9em; white-space: nowrap; }
        table td { padding: 12px 15px; border-bottom: 1px solid #ddd; font-size: 0.9em; }
        table tr:hover { background: #f5f5f5; }
        table input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .alert { padding: 15px; border-radius: 8px; margin: 20px 0; display: none; }
        .alert.show { display: block; animation: slideIn 0.5s; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .alert-danger { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .alert-info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner-container { text-align: center; padding: 40px; color: #007bff; font-size: 1.2em; }
        .empty-state { text-align: center; padding: 40px; color: #666; }
        .empty-state-icon { font-size: 3em; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Gestor de Manifiesto de Env√≠os</h1>
            <p>Selecciona los pedidos para generar el documento de env√≠o</p>
        </div>

        <div class="content">
            <div id="mainPanel" class="panel">
                <div class="controles">
                    <div class="form-group">
                        <label for="fechaInicio">Fecha Desde:</label>
                        <input type="date" id="fechaInicio">
                    </div>
                    <div class="form-group">
                        <label for="fechaFin">Fecha Hasta:</label>
                        <input type="date" id="fechaFin">
                    </div>
                    <div class="form-group">
                         <label for="courierSelect">Filtrar por Transportista:</label>
                         <select id="courierSelect">
                             <option value="Todos">Todos</option>
                         </select>
                    </div>
                    <button class="btn btn-primary" id="btnCargar" onclick="cargarPedidos()">üîÑ Cargar Pedidos</button>
                    <button class="btn btn-success" id="btnGenerar" onclick="generarManifiesto()" disabled>üìÑ Generar Manifiesto</button>
                </div>

                <div id="alertContainer" class="alert"></div>

                <div class="table-wrapper">
                    <div id="pedidosContainer">
                         <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <p>Selecciona filtros y haz clic en "Cargar Pedidos".</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzQGdmrHjy12HN3WiCHIhlQYPG4xzkxKJKQ7p_qUzcS80NukNO2_raeLiBHQQCa7AdYVQ/exec'; // <-- NO OLVIDES PEGAR TU NUEVA URL AQU√ç

        const btnCargar = document.getElementById('btnCargar');
        const btnGenerar = document.getElementById('btnGenerar');
        const pedidosContainer = document.getElementById('pedidosContainer');
        const courierSelect = document.getElementById('courierSelect');

        document.addEventListener('DOMContentLoaded', () => {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = hoy;
            document.getElementById('fechaFin').value = hoy;
        });

        async function cargarPedidos() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const selectedCourier = courierSelect.value;

            if (!fechaInicio || !fechaFin) {
                mostrarAlerta('danger', '‚ùå Debes seleccionar una fecha de inicio y una de fin.');
                return;
            }

            btnCargar.disabled = true;
            btnCargar.innerHTML = '‚è≥ Cargando... <span class="loading"></span>';
            pedidosContainer.innerHTML = '<div class="spinner-container"><div class="loading" style="width:40px;height:40px;"></div><p>Consultando Google Sheets...</p></div>';

            const url = new URL(SCRIPT_URL);
            url.searchParams.append('fechaInicio', fechaInicio);
            url.searchParams.append('fechaFin', fechaFin);
            url.searchParams.append('courier', selectedCourier);

            try {
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    mostrarTablaPedidos(result.data);
                    if (selectedCourier === 'Todos') {
                        actualizarFiltroCourier(result.data);
                    }
                    mostrarAlerta('info', `‚úÖ ${result.data.length} pedido(s) para env√≠o encontrado(s) con los filtros aplicados.`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                pedidosContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error al cargar los pedidos. Revisa la consola para m√°s detalles.</p></div>';
                mostrarAlerta('danger', `‚ùå Error: ${error.message}`);
                console.error("Error al cargar pedidos:", error);
            } finally {
                btnCargar.disabled = false;
                btnCargar.innerHTML = 'üîÑ Cargar Pedidos';
            }
        }

        function mostrarTablaPedidos(pedidos) {
             if (pedidos.length === 0) {
                 const filtroCourier = courierSelect.value;
                 if (filtroCourier === 'Todos') {
                    pedidosContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No se encontraron pedidos pendientes en el rango de fechas seleccionado.</p></div>';
                 } else {
                    pedidosContainer.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No se encontraron pedidos pendientes para el transportista "${filtroCourier}" en el rango de fechas seleccionado.</p></div>`;
                 }
                 btnGenerar.disabled = true;
                 return;
             }

             let html = `
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
                            <th>Origen</th>
                            <th>Cliente</th>
                            <th>Vendedor</th>
                            <th>N¬∞ Venta</th>
                            <th>Transporte</th>
                        </tr>
                    </thead>
                    <tbody>
             `;

             pedidos.forEach((pedido, index) => {
                 html += `
                    <tr>
                        <td><input type="checkbox" class="pedido-checkbox" data-row="${pedido.rowNum}" checked></td>
                        <td>${pedido.origen}</td>
                        <td>${pedido.cliente}</td>
                        <td>${pedido.vendedor}</td>
                        <td>${pedido.boleta}</td>
                        <td>${pedido.transporte}</td>
                    </tr>
                 `;
             });

             html += `
                    </tbody>
                </table>
             `;

             pedidosContainer.innerHTML = html;
             btnGenerar.disabled = false;
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.pedido-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function obtenerPedidosSeleccionados() {
            const checkboxes = document.querySelectorAll('.pedido-checkbox:checked');
            const pedidosSeleccionados = [];
            const filasParaMarcar = [];

            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const cells = row.cells;
                const pedido = {
                    origen: cells[1].textContent,
                    cliente: cells[2].textContent,
                    vendedor: cells[3].textContent,
                    boleta: cells[4].textContent,
                    transporte: cells[5].textContent,
                    rowNum: parseInt(checkbox.dataset.row)
                };
                pedidosSeleccionados.push(pedido);
                filasParaMarcar.push(pedido.rowNum);
            });

            return { pedidos: pedidosSeleccionados, filas: filasParaMarcar };
        }

        function actualizarFiltroCourier(pedidos) {
            const couriers = [...new Set(pedidos.map(p => p.transporte))].sort();
            courierSelect.innerHTML = '<option value="Todos">Todos</option>';
            couriers.forEach(courier => {
                const option = document.createElement('option');
                option.value = courier;
                option.textContent = courier;
                courierSelect.appendChild(option);
            });
        }

        async function marcarPedidosComoImpresos(filas) {
            if (filas.length === 0) return true;

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'marcarProcesados',
                        rows: filas
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message);
                }
                return true;
            } catch (error) {
                console.error('Error al marcar pedidos:', error);
                mostrarAlerta('danger', `‚ùå Error al marcar pedidos como procesados: ${error.message}`);
                return false;
            }
        }

        async function generarManifiesto() {
            const { pedidos, filas } = obtenerPedidosSeleccionados();

            if (pedidos.length === 0) {
                mostrarAlerta('danger', '‚ùå Debes seleccionar al menos un pedido.');
                return;
            }

            btnGenerar.disabled = true;
            btnGenerar.innerHTML = '‚è≥ Generando... <span class="loading"></span>';

            try {
                // Separar ML de otros transportes
                const pedidosML = pedidos.filter(p => p.origen.toLowerCase() === 'ml');
                const pedidosOtros = pedidos.filter(p => p.origen.toLowerCase() !== 'ml');

                // Generar PDF con formato vertical y dos columnas
                await generarPDFVertical(pedidosOtros, pedidosML);

                // Marcar como procesados
                const marcado = await marcarPedidosComoImpresos(filas);
                if (marcado) {
                    mostrarAlerta('success', '‚úÖ Manifiesto generado y pedidos marcados como procesados correctamente.');
                    // Recargar autom√°ticamente
                    setTimeout(() => cargarPedidos(), 2000);
                } else {
                    mostrarAlerta('info', 'üìÑ Manifiesto generado, pero hubo problemas al marcar los pedidos. Verifica manualmente.');
                }

            } catch (error) {
                console.error('Error al generar manifiesto:', error);
                mostrarAlerta('danger', `‚ùå Error al generar manifiesto: ${error.message}`);
            } finally {
                btnGenerar.disabled = false;
                btnGenerar.innerHTML = 'üìÑ Generar Manifiesto';
            }
        }

        function generarPDFVertical(pedidos, pedidosML) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // Orientaci√≥n vertical (portrait)

            const fecha = new Date().toLocaleDateString('es-CL');
            const hora = new Date().toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit'});
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 15;
            const footerHeight = 50;
            const totalPedidos = pedidos.length + pedidosML.length;

            const addHeader = (isFirstPage) => {
                const headerStartY = 10;
                if (isFirstPage) {
                   doc.setFontSize(18);
                   doc.setFont(undefined, 'bold');
                   doc.text('Manifiesto de Env√≠os', pageWidth / 2, headerStartY + 8, { align: 'center' });
                   doc.setFont(undefined, 'normal');
                   doc.setFontSize(10);
                   doc.text(`Generado el: ${fecha} a las ${hora}`, margin, headerStartY + 20);
                   doc.text(`Total Env√≠os: ${totalPedidos}`, margin, headerStartY + 26);
                   doc.text(`Generado por: _________________________`, margin + 60, headerStartY + 20);
                   
                   doc.setLineWidth(0.5);
                   doc.line(margin, headerStartY + 30, pageWidth - margin, headerStartY + 30);
                } else {
                    doc.setFontSize(10);
                    doc.setTextColor(100);
                    doc.text(`Manifiesto de Env√≠os - ${fecha} (Cont.)`, margin, headerStartY + 5);
                    doc.setTextColor(0);
                    doc.setLineWidth(0.3);
                    doc.line(margin, headerStartY + 8, pageWidth - margin, headerStartY + 8);
                }
                return headerStartY + (isFirstPage ? 35 : 12);
            };

            const addFooter = () => {
                const startYPie = pageHeight - footerHeight + 5;
                doc.setLineWidth(0.5);
                doc.line(margin, startYPie, pageWidth - margin, startYPie);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Revisado por Bodega:', margin, startYPie + 8);
                doc.setFont(undefined, 'normal');
                doc.line(margin + 45, startYPie + 6, pageWidth - margin, startYPie + 6);
                
                doc.setFont(undefined, 'bold');
                doc.text('Observaciones:', margin, startYPie + 18);
                doc.setFont(undefined, 'normal');
                // L√≠neas para escribir observaciones
                for (let i = 0; i < 4; i++) {
                    doc.line(margin, startYPie + 22 + (i * 6), pageWidth - margin, startYPie + 22 + (i * 6));
                }
            };

            // Agrupar pedidos por transporte
            const pedidosAgrupados = pedidos.reduce((acc, pedido) => {
                const transporte = pedido.transporte;
                if (!acc[transporte]) acc[transporte] = [];
                acc[transporte].push(pedido);
                return acc;
            }, {});

            let currentY;
            let isFirstPageOfDocument = true;
            const transportesOrdenados = Object.keys(pedidosAgrupados).sort();

            transportesOrdenados.forEach((transporte, transporteIndex) => {
                const grupoPedidos = pedidosAgrupados[transporte];
                
                // Verificar si necesitamos nueva p√°gina
                const espacioNecesario = 25 + (Math.ceil(grupoPedidos.length / 2) * 12) + 10;
                if (transporteIndex > 0 && (currentY + espacioNecesario > pageHeight - footerHeight)) {
                    addFooter();
                    doc.addPage();
                    isFirstPageOfDocument = false;
                    currentY = addHeader(false);
                }

                // A√±adir encabezado si es la primera p√°gina
                if (isFirstPageOfDocument && transporteIndex === 0) {
                    currentY = addHeader(true);
                } else if (transporteIndex === 0 && !isFirstPageOfDocument) {
                    currentY = addHeader(false);
                }

                // T√≠tulo del transporte
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`Transporte: ${transporte}`, margin, currentY);
                doc.setFont(undefined, 'normal');
                currentY += 8;

                // Encabezados de columnas
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                const col1X = margin;
                const col2X = pageWidth / 2 + 5;
                
                doc.text('‚òê Cliente - Vendedor - N¬∞ Venta', col1X, currentY);
                doc.text('‚òê Cliente - Vendedor - N¬∞ Venta', col2X, currentY);
                doc.setFont(undefined, 'normal');
                currentY += 6;

                // Dibujar pedidos en dos columnas
                for (let i = 0; i < grupoPedidos.length; i += 2) {
                    const pedido1 = grupoPedidos[i];
                    const pedido2 = grupoPedidos[i + 1];

                    doc.setFontSize(8);
                    
                    // Columna 1
                    if (pedido1) {
                        doc.rect(col1X, currentY - 3, 3, 3); // Casilla para marcar
                        const texto1 = `${pedido1.cliente} - ${pedido1.vendedor} - ${pedido1.boleta}`;
                        const lineas1 = doc.splitTextToSize(texto1, (pageWidth / 2) - 15);
                        doc.text(lineas1, col1X + 5, currentY);
                    }
                    
                    // Columna 2
                    if (pedido2) {
                        doc.rect(col2X, currentY - 3, 3, 3); // Casilla para marcar
                        const texto2 = `${pedido2.cliente} - ${pedido2.vendedor} - ${pedido2.boleta}`;
                        const lineas2 = doc.splitTextToSize(texto2, (pageWidth / 2) - 20);
                        doc.text(lineas2, col2X + 5, currentY);
                    }
                    
                    currentY += 8;
                }
                
                currentY += 5; // Espacio entre transportes
            });

            // Agregar secci√≥n de ML al final si existe
            if (pedidosML.length > 0) {
                // Verificar espacio para la secci√≥n ML
                const espacioML = 20;
                if (currentY + espacioML > pageHeight - footerHeight) {
                    addFooter();
                    doc.addPage();
                    currentY = addHeader(false);
                }

                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Nota - Env√≠os MercadoLibre:', margin, currentY);
                doc.setFont(undefined, 'normal');
                currentY += 6;

                doc.setFontSize(8);
                const clientesML = pedidosML.map(p => p.cliente).join(', ');
                const lineasML = doc.splitTextToSize(clientesML, pageWidth - (margin * 2));
                doc.text(lineasML, margin, currentY);
            }

            // A√±adir pie a la √∫ltima p√°gina
            addFooter();

            doc.save(`Manifiesto_Envios_${fecha.replace(/\//g, '-')}.pdf`);
        }

        function mostrarAlerta(tipo, mensaje) {
            const alert = document.getElementById('alertContainer');
            alert.className = `alert alert-${tipo} show`;
            alert.innerHTML = mensaje;

            setTimeout(() => {
                alert.classList.remove('show');
            }, 8000);
        }
    </script>
</body>
</html>
